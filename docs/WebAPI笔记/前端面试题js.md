## 前端面试题---一个页面从输入 URL 到页面加载显示完成，这个过程中都发生了什么？

作者：低端外包程序员

链接：https://zhuanlan.zhihu.com/p/53351608

来源：知乎

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

总体来说分为以下几个过程:

       1. DNS解析
       2. TCP连接
       3. 发送HTTP请求
       4. 服务器处理请求并返回HTTP报文
       5. 浏览器解析渲染页面
       6. 连接结束

详解：
#### 1.DNS解析

* （Domain Name System，域名系统）

  DNS解析的过程就是寻找哪台机器上有你需要资源的过程。当你在浏览器中输入一个地址时，例如http://www.baidu.com，其实不是百度网站真正意义上的地址。互联网上每一台计算机的唯一标识是它的IP地址，但是IP地址并不方便记忆。用户更喜欢用方便记忆的网址去寻找互联网上的其它计算机，也就是上面提到的百度的网址。所以互联网设计者需要在用户的方便性与可用性方面做一个权衡，这个权衡就是一个网址到IP地址的转换，这个过程就是DNS解析。它实际上充当了一个翻译的角色，实现了网址到IP地址的转换。
  当然如果你直接输入的是另一台电脑的IP地址来访问它，那么则不存在这一步。

#### 2.TCP连接（三次握手）

* 知道了服务器的 IP 地址，下面便开始与服务器建立连接了。
* 通俗地讲，通信连接的建立需要经历以下三个过程：
  * 主机向服务器发送一个建立连接的请求（您好，我想认识您）；
  * 服务器接到请求后发送同意连接的信号（好的，很高兴认识您）；
  * 主机接到同意连接的信号后，再次向服务器发送了确认信号（我也很高兴认识您），
* 自此，主机与服务器两者建立了连接。（三次握手的过程采用 TCP 协议，其可以保证信息传输的可靠性，三次握手过程中，若一方收不到确认信号，协议会要求重新发送信号）

#### 3.发送HTTP请求

当服务器与主机建立了连接之后，下面主机便与服务器进行通信。网页请求是一个单向请求的过程，即是一个主机向服务器请求数据，服务器返回相应的数据的过程。
浏览器根据 URL 内容生成 HTTP 请求，HTTP请求报文是由三部分组成: 请求行, 请求报头和请求正文；
如：

```HTTP 
    1 POST /path HTTP/1.1
    2 Host: passport.zhihu.com
    2 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36
    2 Accept: */*
    2 Content-Length: 24
    2 Content-Type: application/x-www-form-urlencoded
    3
    4 username=ff&password=123
```



#### 服务器处理请求并返回HTTP报文

​        服务器接到请求后，会根据 HTTP 请求中的内容来决定如何获取相应的 HTML 文件；

​        服务器将得到的 HTML 文件发送给浏览器；
​        HTTP响应报文也是由三部分组成: 状态码, 响应报头和响应报文
​        4.1 状态码
​            1xx：指示信息–表示请求已接收，继续处理。
​            2xx：成功–表示请求已被成功接收、理解、接受。
​            3xx：重定向–要完成请求必须进行更进一步的操作。
​            4xx：客户端错误–请求有语法错误或请求无法实现。
​            5xx：服务器端错误–服务器未能实现合法的请求。
​        4.2 响应报头
​            常见的响应报头字段有: Server, Connection...
​        4.3 响应报文
​            服务器返回给浏览器的文本信息，通常HTML, CSS, JS, 图片等文件就放在这一部分。

#### 5. 浏览器解析渲染页面

​        在浏览器还没有完全接收 HTML 文件时便开始渲染、显示网页；
​        在执行 HTML 中代码时，根据需要，浏览器会继续请求图片、CSS、JavsScript等文件，过程同请求 HTML ；

​        浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。这个过程比较复杂，涉及到两个概念: reflow(回流)和repain(重绘)。DOM节点中的各个元素都是以盒模型的形式存在，这些都需要浏览器去计算其位置和大小等，这个过程称为relow;当盒模型的位置,大小以及其他属性，如颜色,字体,等确定下来之后，浏览器便开始绘制内容，这个过程称为repain。页面在首次加载时必然会经历reflow和repain。reflow和repain过程是非常消耗性能的，尤其是在移动设备上，它会破坏用户体验，有时会造成页面卡顿。所以我们应该尽可能少的减少reflow和repain。

​        JS的解析是由浏览器中的JS解析引擎完成的。JS是单线程运行，也就是说，在同一个时间内只能做一件事，所有的任务都需要排队，前一个任务结束，后一个任务才能开始。但是又存在某些任务比较耗时，如IO读写等，所以需要一种机制可以先执行排在后面的任务，这就是：同步任务(synchronous)和异步任务(asynchronous)。JS的执行机制就可以看做是一个主线程加上一个任务队列(task queue)。同步任务就是放在主线程上执行的任务，异步任务是放在任务队列中的任务。所有的同步任务在主线程上执行，形成一个执行栈;异步任务有了运行结果就会在任务队列中放置一个事件；脚本运行时先依次运行执行栈，然后会从任务队列里提取事件，运行任务队列中的任务，这个过程是不断重复的，所以又叫做事件循环(Event loop)。

​        浏览器在解析过程中，如果遇到请求外部资源时，如图像,iconfont,JS等。浏览器将重复1-6过程下载该资源。请求过程是异步的，并不会影响HTML文档进行加载，但是当文档加载过程中遇到JS文件，HTML文档会挂起渲染过程，不仅要等到文档中JS文件加载完毕还要等待解析执行完毕，才会继续HTML的渲染过程。原因是因为JS有可能修改DOM结构，这就意味着JS执行完成前，后续所有资源的下载是没有必要的，这就是JS阻塞后续资源下载的根本原因。CSS文件的加载不影响JS文件的加载，但是却影响JS文件的执行。JS代码执行前浏览器必须保证CSS文件已经下载并加载完毕

#### 6. 连接结束

​        主机向服务器发送一个断开连接的请求（不早了，我该走了）；
​        服务器接到请求后发送确认收到请求的信号（知道了）；
​        服务器向主机发送断开通知（我也该走了）；
​        主机接到断开通知后断开连接并反馈一个确认信号（嗯，好的），服务器收到确认信号后断开连接；